<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kalkulator Faktor Kepelbagaian | MS 1979</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8fafc; margin: 0; padding: 0; color:#1e293b; }
    header { background: linear-gradient(90deg,#2563eb,#1e40af); color: #fff; padding: 2rem 1rem; text-align: center; }
    header h1 { margin:0; font-size: 1.8rem; }
    header p { margin:0.3rem 0 0; }
    .container { max-width: 1100px; margin: auto; padding: 1rem; }
    .card { background: #fff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); margin-bottom: 1.5rem; }
    .form-group { margin-bottom: 1rem; }
    label { font-weight: bold; display: block; margin-bottom: 0.3rem; }
    input, select { width: 100%; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 6px; }
    button { background: #2563eb; color: #fff; padding: 0.7rem 1.2rem; border: none; border-radius: 6px; cursor: pointer; font-size:0.95rem; }
    button:hover { background: #1e40af; }
    .btn-danger { background: #ef4444; }
    .btn-danger:hover { background: #b91c1c; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
    table, th, td { border: 1px solid #e2e8f0; }
    th, td { padding: 0.7rem; text-align: left; vertical-align: top; }
    th { background: #2563eb; color: #fff; text-align: center; }
    tfoot td { font-weight: bold; background: #f1f5f9; text-align: center; }
    hr { margin:1rem 0; border:0; border-top:1px solid #e2e8f0;}
    h2 { margin-top:0; color:#1e40af; }
  </style>
</head>
<body>
  <header>
    <h1>Kalkulator Faktor Kepelbagaian</h1>
    <p>Berdasarkan piawaian elektrik Malaysia (MS 1979)</p>
  </header>

  <div class="container">
    <div class="card">
      <div class="form-group">
        <label for="voltage">Voltan Sistem (V)</label>
        <input type="number" id="voltage" value="240" readonly>
      </div>

      <div id="load-list"></div>
      <button id="calculate-btn">Kira</button>
      <button id="add-load">Tambah Beban</button>

      <div id="results"></div>
    </div>

    <div class="card">
      <h2>Rujukan Faktor Kepelbagaian</h2>
      <table>
        <thead>
          <tr>
            <th>Jenis Beban</th>
            <th>Arus Maksimum</th>
            <th>Arus Anggaran</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Lampu (Filamen)</td>
            <td>Bilangan Beban × Kuasa / 240V</td>
            <td>66% daripada jumlah arus maksimum</td>
          </tr>
          <tr>
            <td>Pemanasan dan Kuasa</td>
            <td>Bilangan Beban × Kuasa / 240V</td>
            <td>100% jumlah permintaan arus sehingga 10A + 50% permintaan arus selebihnya</td>
          </tr>
          <tr>
            <td>Pemasak</td>
            <td>Bilangan Beban × Kuasa / 240V</td>
            <td>10A + 30% beban penuh peralatan tersambung + 5A untuk litar kawalan / bantuan</td>
          </tr>
          <tr>
            <td>Pemanas Air</td>
            <td>Bilangan Beban × Kuasa / 240V</td>
            <td>100% 2 beban terbesar + 25% beban penuh yang lain</td>
          </tr>
          <tr>
            <td>Pemanas Air (Kawalan Laras Suhu)</td>
            <td>Bilangan Beban × Kuasa / 240V</td>
            <td>100% (Faktor Kepelbagaian tidak dibenarkan)</td>
          </tr>
          <tr>
            <td>Pemanas Lantai</td>
            <td>Bilangan Beban × Kuasa / 240V</td>
            <td>100% (Faktor Kepelbagaian tidak dibenarkan)</td>
          </tr>
          <tr>
            <td>Pemanas Ruang Terma</td>
            <td>Bilangan Beban × Kuasa / 240V</td>
            <td>100% (Faktor Kepelbagaian tidak dibenarkan)</td>
          </tr>
          <tr>
            <td>Susunan Litar Akhir</td>
            <td>Bilangan Beban × Kuasa / 240V</td>
            <td>100% arus litar terbesar + 40% jumlah arus litar akhir lain</td>
          </tr>
          <tr>
            <td>Soket Alir Keluar (selain 9 peralatan khas)</td>
            <td>Contoh: 2×13A=20A, 4×13A=20A, Jumlah=80A</td>
            <td>100% titik pengunaan terbesar + 40% arus titik pengunaan lain<br>
              Contoh: 100%×20A + 40%×(80A–20A) = 20A + 24A = 44A
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <h2>Cara Menggunakan Kalkulator</h2>
      <ol>
        <li>Pilih <b>Jenis Beban</b> daripada senarai.</li>
        <li>Masukkan <b>Bilangan Beban</b> dan <b>Kuasa (W)</b> setiap beban.</li>
        <li>Tambah seberapa banyak beban yang diperlukan.</li>
        <li>Sekurang-kurangnya 1 beban perlu ada (tidak boleh padam semua).</li>
        <li>Tekan butang <b>Kira</b> untuk melihat keputusan arus maksimum dan arus anggaran.</li>
      </ol>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const loadList = document.getElementById('load-list');
      const addLoadBtn = document.getElementById('add-load');
      const calcBtn = document.getElementById('calculate-btn');
      const resultsDiv = document.getElementById('results');
      const voltageInput = document.getElementById('voltage');

      addLoad();
      addLoadBtn.addEventListener('click', addLoad);
      calcBtn.addEventListener('click', calculate);

      function addLoad() {
        const div = document.createElement('div');
        div.className = 'load-item';
        div.innerHTML = `
          <div class="form-group">
            <label>Bilangan Beban</label>
            <input type="number" class="load-qty" min="1" value="1">
          </div>
          <div class="form-group">
            <label>Kuasa Setiap Beban (W)</label>
            <input type="number" class="load-power" value="60">
          </div>
          <div class="form-group">
            <label>Jenis Beban</label>
            <select class="load-type">
              <option value="lighting">Lampu (Filamen)</option>
              <option value="fluorescent">Lampu (Kalimantang)</option>
              <option value="ceiling_fan">Kipas Siling</option>
              <option value="aircond">Penghawa Dingin (A/C)</option>
              <option value="heating_power">Pemanasan dan Kuasa</option>
              <option value="cooking">Perkakas Memasak</option>
              <option value="water_heater">Pemanas Air</option>
              <option value="water_heater_controlled">Pemanas Air (Kawalan Suhu)</option>
              <option value="floor_heater">Pemanas Lantai</option>
              <option value="space_heater">Pemanas Ruang</option>
              <option value="final_circuit">Susunan Litar Akhir</option>
              <option value="other_sockets">Soket Alir Keluar Lain</option>
            </select>
          </div>
          <button class="btn-danger remove-load">Padam</button>
          <hr>
        `;
        div.querySelector('.remove-load').addEventListener('click', () => {
          if (document.querySelectorAll('.load-item').length === 1) {
            alert("Sekurang-kurangnya satu beban perlu ada. Anda tidak boleh padam semua beban.");
          } else {
            div.remove();
          }
        });
        loadList.appendChild(div);
      }

      function calculate() {
        const V = parseFloat(voltageInput.value);
        const loads = Array.from(document.querySelectorAll('.load-item')).map(item => {
          const qty = parseFloat(item.querySelector('.load-qty').value) || 0;
          const P = parseFloat(item.querySelector('.load-power').value) || 0;
          const type = item.querySelector('.load-type').value;
          return { qty, P, type };
        }).filter(l => l.qty > 0 && l.P > 0);

        if (loads.length === 0) {
          alert("Anda perlu mempunyai sekurang-kurangnya satu beban untuk pengiraan.");
          return;
        }

        let totalMax = 0, totalEst = 0;
        let rows = '';

        const groups = {};
        loads.forEach(l => {
          if (!groups[l.type]) groups[l.type] = [];
          groups[l.type].push(l);
        });

        for (const [type, group] of Object.entries(groups)) {
          let groupMax = 0;
          let groupEst = 0;

          switch (type) {
            case 'lighting':
              groupMax = group.reduce((s, l) => s + (l.qty * l.P) / V, 0);
              groupEst = groupMax * 0.66;
              break;
            case 'fluorescent':
              groupMax = group.reduce((s, l) => s + (l.qty * l.P * 1.8) / V, 0);
              groupEst = groupMax * 0.66;
              break;
            case 'ceiling_fan':
              groupMax = group.reduce((s, l) => s + (l.qty * l.P) / (V * 0.85), 0);
              groupEst = groupMax * 0.66;
              break;
            case 'aircond':
              groupMax = group.reduce((s, l) => s + (l.qty * l.P) / (V * 0.85), 0);
              groupEst = groupMax;
              break;
            case 'heating_power':
              groupMax = group.reduce((s, l) => s + (l.qty * l.P) / V, 0);
              groupEst = groupMax <= 10 ? groupMax : 10 + (groupMax - 10) * 0.5;
              break;
            case 'cooking':
              groupMax = group.reduce((s, l) => s + (l.qty * l.P) / V, 0);
              groupEst = 10 + (groupMax > 10 ? (groupMax - 10) * 0.3 : 0) + 5;
              break;
            case "water_heater":
  		groupMax = group.reduce((s, l) => s + (l.qty*l.P)/V, 0);

  		// Pecahkan setiap unit beban
  		let allLoads = [];
  		group.forEach(l => {
  		  for (let i = 0; i < l.qty; i++) {
  		    allLoads.push(l.P / V);
   		 }
  		});

  		// Susun ikut besar → kecil
  		allLoads.sort((a,b) => b-a);

  		// 2 beban terbesar 100%
  		if (allLoads[0]) groupEst += allLoads[0];
  		if (allLoads[1]) groupEst += allLoads[1];

  		// Lebihan 25%
  		if (allLoads.length > 2) {
   		 const baki = allLoads.slice(2).reduce((s,x)=>s+x,0);
  		  groupEst += baki * 0.25;
  		}
  		break;


            case 'water_heater_controlled':
            case 'floor_heater':
            case 'space_heater':
              groupMax = group.reduce((s, l) => s + (l.qty * l.P) / V, 0);
              groupEst = groupMax;
              break;
            case 'final_circuit':
              groupMax = group.reduce((s, l) => s + (l.qty * l.P) / V, 0);
              const sortCir = [...group].map(l => (l.qty * l.P) / V).sort((a, b) => b - a);
              if (sortCir[0]) groupEst += sortCir[0];
              if (sortCir.length > 1) {
                const others = sortCir.slice(1).reduce((s, x) => s + x, 0);
                groupEst += others * 0.4;
              }
              break;
            case 'other_sockets':
              const sockets = Math.ceil(group.length / 2);
              const totalSocket = sockets * 20;
              groupMax = totalSocket;
              groupEst = sockets === 1 ? 20 : 20 + (totalSocket - 20) * 0.4;
              break;
            default:
              groupMax = group.reduce((s, l) => s + (l.qty * l.P) / V, 0);
              groupEst = groupMax;
          }

          totalMax += groupMax;
          totalEst += groupEst;

          rows += `<tr>
            <td>${labelType(type)}</td>
            <td style="text-align:center">${groupMax.toFixed(2)}</td>
            <td style="text-align:center">${groupEst.toFixed(2)}</td>
          </tr>`;
        }

        resultsDiv.innerHTML = `
          <h3>Keputusan</h3>
          <table>
            <thead>
              <tr><th>Jenis Beban</th><th>Arus Maksimum (A)</th><th>Arus Anggaran (A)</th></tr>
            </thead>
            <tbody>${rows}</tbody>
            <tfoot>
              <tr><td style="text-align:center">Jumlah</td><td style="text-align:center">${totalMax.toFixed(2)}</td><td style="text-align:center">${totalEst.toFixed(2)}</td></tr>
            </tfoot>
          </table>
        `;
      }

      function labelType(type) {
        switch (type) {
          case 'lighting': return 'Lampu (Filamen)';
          case 'fluorescent': return 'Lampu (Kalimantang)';
          case 'ceiling_fan': return 'Kipas Siling';
          case 'aircond': return 'Penghawa Dingin (A/C)';
          case 'heating_power': return 'Pemanasan dan Kuasa';
          case 'cooking': return 'Perkakas Memasak';
          case 'water_heater': return 'Pemanas Air';
          case 'water_heater_controlled': return 'Pemanas Air (Kawalan Suhu)';
          case 'floor_heater': return 'Pemanas Lantai';
          case 'space_heater': return 'Pemanas Ruang';
          case 'final_circuit': return 'Susunan Litar Akhir';
          case 'other_sockets': return 'Soket Alir Keluar Lain';
          default: return type;
        }
      }
    });
  </script>
</body>
</html>

